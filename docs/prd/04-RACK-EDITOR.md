# F04: 랙 상세 에디터 - 상세 PRD

## 1. 개요

### 1.1 기능 ID
**F04-RACK-EDITOR**

### 1.2 기능 설명
랙 내부를 정면도(Front View) 형태로 시각화하고 편집하는 기능. U 슬롯 그리드에 설비를 배치하고 관리한다.

### 1.3 우선순위
**P0** (필수) - 핵심 기능

---

## 2. 요구사항

### 2.1 기능 요구사항

#### FR-01: 랙 정면도 뷰
| 항목 | 내용 |
|------|------|
| U 슬롯 그리드 | 1U~42U (또는 설정값) 슬롯 표시 |
| U 번호 표시 | 좌측에 U 번호 표시 (하단 1U) |
| 설비 표시 | 슬롯에 설비 블록 표시 |

#### FR-02: 설비 배치
| 항목 | 내용 |
|------|------|
| 배치 | 드래그&드롭으로 U 슬롯에 배치 |
| 크기 | 설비 높이(U 수) 지정 |
| 이동 | 드래그로 다른 슬롯으로 이동 |
| 중복 방지 | 슬롯 중복 배치 방지 |

#### FR-03: 설비 정보 관리
| 항목 | 내용 |
|------|------|
| 기본 정보 | 이름, 모델명, 시리얼번호, 제조사 |
| 설치 정보 | 설치일, 담당자, U 위치 |
| 포트 정의 | AC/DC/LAN/광 포트 목록 |
| 메모 | 자유 형식 메모 |

#### FR-04: 랙 사진 관리
| 항목 | 내용 |
|------|------|
| 정면 사진 | 랙 정면 사진 1장 업로드 |
| 후면 사진 | 랙 후면 사진 1장 업로드 |
| 미리보기 | 클릭 시 원본 크기 보기 |

#### FR-05: 편집 기능
| 항목 | 내용 |
|------|------|
| 선택 | 클릭으로 설비 선택 |
| 삭제 | 선택 후 Delete 또는 삭제 버튼 |
| 복사 | 설비 복사 (포트 제외) |
| Undo/Redo | 편집 취소/재실행 |

### 2.2 비기능 요구사항

| 항목 | 요구사항 |
|------|----------|
| 랙당 설비 수 | 최대 42개 (1U 기준) |
| 설비당 포트 수 | 최대 100개 |
| 이미지 크기 | 최대 5MB/장 |

---

## 3. 데이터 모델

### 3.1 Equipment 테이블
```sql
CREATE TABLE equipment (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    rack_id         UUID NOT NULL REFERENCES racks(id) ON DELETE CASCADE,
    name            VARCHAR(100) NOT NULL,
    model           VARCHAR(100),
    manufacturer    VARCHAR(100),
    serial_number   VARCHAR(100),
    -- U 슬롯 위치
    start_u         INT NOT NULL,           -- 시작 U (하단 기준)
    height_u        INT NOT NULL DEFAULT 1, -- 높이 (U 수)
    -- 추가 정보
    install_date    DATE,
    manager         VARCHAR(100),           -- 담당자
    description     TEXT,
    properties      JSONB,                  -- 추가 속성 (자유 형식)
    -- 메타
    sort_order      INT DEFAULT 0,
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by      UUID REFERENCES users(id),
    updated_by      UUID REFERENCES users(id),

    -- U 슬롯 범위 검증 (트리거로 구현)
    CONSTRAINT valid_u_position CHECK (start_u >= 1 AND height_u >= 1)
);

-- 동일 랙 내 U 슬롯 중복 방지를 위한 함수/트리거 필요
```

### 3.2 Port 테이블
```sql
CREATE TABLE ports (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    equipment_id    UUID NOT NULL REFERENCES equipment(id) ON DELETE CASCADE,
    name            VARCHAR(50) NOT NULL,       -- 포트 이름 (예: eth0, power1)
    port_type       VARCHAR(20) NOT NULL,       -- 'AC', 'DC', 'LAN', 'FIBER', 'OTHER'
    port_number     INT,                        -- 포트 번호 (순서)
    label           VARCHAR(100),               -- 라벨 (예: "Management Port")
    speed           VARCHAR(50),                -- 속도 (예: "1Gbps", "10Gbps")
    description     TEXT,
    sort_order      INT DEFAULT 0,
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- port_type enum
-- 'AC': AC 전원
-- 'DC': DC 전원
-- 'LAN': 이더넷 (UTP/STP)
-- 'FIBER': 광케이블
-- 'OTHER': 기타
```

---

## 4. API 명세

### 4.1 랙 상세 조회
```
GET /api/racks/:id

Response (200):
{
    "id": "uuid",
    "name": "RACK-A01",
    "code": "A01",
    "totalU": 42,
    "description": "메인 서버 랙",
    "frontImageUrl": "/uploads/racks/xxx/front.jpg",
    "rearImageUrl": "/uploads/racks/xxx/rear.jpg",
    "floorPlan": {
        "id": "uuid",
        "name": "B1층 ICT실"
    },
    "equipment": [
        {
            "id": "uuid",
            "name": "서버 #1",
            "model": "Dell R740",
            "manufacturer": "Dell",
            "serialNumber": "ABC123",
            "startU": 38,
            "heightU": 4,
            "installDate": "2024-01-15",
            "manager": "홍길동",
            "portCount": 8
        },
        {
            "id": "uuid",
            "name": "스위치 #1",
            "model": "Cisco 9300",
            "startU": 34,
            "heightU": 1,
            "portCount": 48
        }
    ],
    "usedU": 28,
    "availableU": 14,
    "createdAt": "datetime",
    "updatedAt": "datetime"
}
```

### 4.2 랙 수정
```
PUT /api/racks/:id
Authorization: Bearer {accessToken}
Role: admin

Request:
{
    "name": "string",
    "code": "string",
    "totalU": 42,
    "description": "string"
}

Response (200):
{
    "id": "uuid",
    ...
}
```

### 4.3 설비 목록 조회
```
GET /api/racks/:rackId/equipment

Response (200):
{
    "equipment": [
        {
            "id": "uuid",
            "name": "서버 #1",
            "model": "Dell R740",
            "startU": 38,
            "heightU": 4,
            "ports": [
                {
                    "id": "uuid",
                    "name": "eth0",
                    "portType": "LAN",
                    "isConnected": true
                }
            ]
        }
    ]
}
```

### 4.4 설비 생성
```
POST /api/racks/:rackId/equipment
Authorization: Bearer {accessToken}
Role: admin

Request:
{
    "name": "서버 #1",
    "model": "Dell R740",
    "manufacturer": "Dell",
    "serialNumber": "ABC123",
    "startU": 38,
    "heightU": 4,
    "installDate": "2024-01-15",
    "manager": "홍길동",
    "description": "메인 웹 서버"
}

Response (201):
{
    "id": "uuid",
    "name": "서버 #1",
    ...
}

Error (409):
{
    "error": "U_SLOT_CONFLICT",
    "message": "해당 U 슬롯에 이미 설비가 있습니다.",
    "conflictingEquipment": {
        "id": "uuid",
        "name": "기존 설비",
        "startU": 36,
        "heightU": 4
    }
}
```

### 4.5 설비 수정
```
PUT /api/equipment/:id
Authorization: Bearer {accessToken}
Role: admin

Request:
{
    "name": "string",
    "model": "string",
    "manufacturer": "string",
    "serialNumber": "string",
    "startU": 38,
    "heightU": 4,
    "installDate": "date",
    "manager": "string",
    "description": "string"
}

Response (200):
{
    "id": "uuid",
    ...
}
```

### 4.6 설비 삭제
```
DELETE /api/equipment/:id
Authorization: Bearer {accessToken}
Role: admin

Response (200):
{
    "message": "설비가 삭제되었습니다."
}

Error (409):
{
    "error": "HAS_CONNECTIONS",
    "message": "연결된 케이블이 있어 삭제할 수 없습니다. 케이블을 먼저 제거하세요.",
    "connectionCount": 5
}
```

### 4.7 설비 이동 (U 위치 변경)
```
PATCH /api/equipment/:id/move
Authorization: Bearer {accessToken}
Role: admin

Request:
{
    "startU": 20
}

Response (200):
{
    "id": "uuid",
    "startU": 20,
    "heightU": 4
}
```

### 4.8 랙 사진 업로드
```
POST /api/racks/:id/images
Authorization: Bearer {accessToken}
Role: admin
Content-Type: multipart/form-data

Form Data:
- type: "front" | "rear"
- file: (image file, max 5MB, jpg/png)

Response (200):
{
    "type": "front",
    "imageUrl": "/uploads/racks/{id}/front_1702000000.jpg"
}
```

### 4.9 랙 사진 삭제
```
DELETE /api/racks/:id/images/:type
Authorization: Bearer {accessToken}
Role: admin

Response (200):
{
    "message": "사진이 삭제되었습니다."
}
```

---

## 5. 화면 설계

### 5.1 랙 상세 에디터 메인 화면 (S07)
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 🗄️ RACK-A01 (메인 서버 랙)                    [저장] [← 평면도]  [뷰어 모드]     │
├───────────────────────────────────────────┬─────────────────────────────────────┤
│                                           │                                     │
│   랙 정면도 (42U)                          │   설비 추가                         │
│                                           │                                     │
│   42 ├─────────────────────────┤          │   이름 *                            │
│   41 ├─────────────────────────┤          │   ┌─────────────────────┐           │
│   40 │                         │          │   │                     │           │
│   39 │      서버 #1 (4U)       │◀─선택    │   └─────────────────────┘           │
│   38 │      Dell R740         │          │                                     │
│   37 │                         │          │   모델명                            │
│   36 ├─────────────────────────┤          │   ┌─────────────────────┐           │
│   35 │      서버 #2 (2U)       │          │   │                     │           │
│   34 │                         │          │   └─────────────────────┘           │
│   33 ├─────────────────────────┤          │                                     │
│   32 │      스위치 #1 (1U)     │          │   높이 (U)                          │
│   31 ├─────────────────────────┤          │   [1] [2] [4] [▼ 직접입력]         │
│   30 ├                         ┤          │                                     │
│   .. │       (빈 슬롯)         │          │   시작 U 위치                       │
│    3 ├                         ┤          │   ┌─────────────────────┐           │
│    2 │        PDU (2U)        │          │   │ 38                  │           │
│    1 │                         │          │   └─────────────────────┘           │
│      └─────────────────────────┘          │                                     │
│                                           │   [+ 설비 추가]                      │
│   사용: 28U / 42U (67%)                   │                                     │
│                                           ├─────────────────────────────────────┤
├───────────────────────────────────────────┤   사진                              │
│   선택된 설비: 서버 #1                     │                                     │
├───────────────────────────────────────────┤   정면        후면                  │
│   모델: Dell R740                         │   ┌──────┐   ┌──────┐              │
│   시리얼: ABC123                          │   │  📷  │   │  📷  │              │
│   위치: 38U~41U (4U)                      │   │      │   │      │              │
│   담당자: 홍길동                           │   └──────┘   └──────┘              │
│   포트: 8개 (LAN 6, AC 2)                 │   [업로드]    [업로드]               │
│                                           │                                     │
│   [상세 편집] [포트 관리] [이동] [삭제]    │                                     │
└───────────────────────────────────────────┴─────────────────────────────────────┘
```

### 5.2 랙 정면도 상세
```
┌────┬─────────────────────────────────────┐
│ U  │              랙 정면도               │
├────┼─────────────────────────────────────┤
│ 42 │                                     │
├────┤  ┌─────────────────────────────┐    │
│ 41 │  │                             │    │
│ 40 │  │        서버 #1 (4U)         │    │  ← 파란색 배경 (선택됨)
│ 39 │  │        Dell R740            │    │
│ 38 │  │                             │    │
├────┤  └─────────────────────────────┘    │
│ 37 │                                     │
├────┤  ┌─────────────────────────────┐    │
│ 36 │  │      서버 #2 (2U)           │    │  ← 회색 배경 (미선택)
│ 35 │  │                             │    │
├────┤  └─────────────────────────────┘    │
│ 34 │  ┌─────────────────────────────┐    │
│    │  │     스위치 #1 (1U)          │    │
├────┤  └─────────────────────────────┘    │
│ 33 │                                     │  ← 빈 슬롯 (점선 테두리)
│ .. │  · · · · · · · · · · · · · · · ·   │
├────┤                                     │
│  2 │  ┌─────────────────────────────┐    │
│  1 │  │        PDU (2U)             │    │  ← 주황색 (전원 장비)
└────┴──┴─────────────────────────────┴────┘

색상 규칙:
- 서버: #4A90D9 (파랑)
- 네트워크: #50C878 (초록)
- 스토리지: #9B59B6 (보라)
- 전원(PDU/UPS): #E67E22 (주황)
- 기타: #95A5A6 (회색)
- 선택됨: 테두리 강조 + 밝은 배경
- 빈 슬롯: 점선 테두리
```

### 5.3 설비 상세 편집 모달
```
┌─────────────────────────────────────────────────────────────┐
│ 설비 편집: 서버 #1                                     [X]  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 기본 정보 │ 포트 관리 │ 연결 현황 │                      │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│  기본 정보                                                  │
│  ─────────────────────────────────────                      │
│  이름 *          ┌─────────────────────────────────┐        │
│                  │ 서버 #1                          │        │
│                  └─────────────────────────────────┘        │
│                                                             │
│  모델명          ┌─────────────────────────────────┐        │
│                  │ Dell R740                        │        │
│                  └─────────────────────────────────┘        │
│                                                             │
│  제조사          ┌─────────────────────────────────┐        │
│                  │ Dell                             │        │
│                  └─────────────────────────────────┘        │
│                                                             │
│  시리얼 번호     ┌─────────────────────────────────┐        │
│                  │ ABC123456                        │        │
│                  └─────────────────────────────────┘        │
│                                                             │
│  설치 정보                                                  │
│  ─────────────────────────────────────                      │
│  U 위치          38U ~ 41U (4U)                             │
│                                                             │
│  설치일          ┌─────────────────────────────────┐        │
│                  │ 2024-01-15           📅         │        │
│                  └─────────────────────────────────┘        │
│                                                             │
│  담당자          ┌─────────────────────────────────┐        │
│                  │ 홍길동                           │        │
│                  └─────────────────────────────────┘        │
│                                                             │
│  설명            ┌─────────────────────────────────┐        │
│                  │ 메인 웹 서버                     │        │
│                  │                                 │        │
│                  └─────────────────────────────────┘        │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                              [취소]  [저장]                  │
└─────────────────────────────────────────────────────────────┘
```

### 5.4 설비 드래그 배치
```
드래그 중 상태:
┌────┬─────────────────────────────────────┐
│ 42 │                                     │
├────┤  ┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐  │
│ 41 │  ╎                               ╎  │  ← 드롭 가능 영역 (초록 점선)
│ 40 │  ╎      새 설비 (4U)             ╎  │
│ 39 │  ╎                               ╎  │
│ 38 │  └ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘  │
├────┤  ┌─────────────────────────────┐    │
│ 37 │  │      기존 설비              │    │  ← 충돌 시 빨간 표시
│ 36 │  └─────────────────────────────┘    │
└────┴─────────────────────────────────────┘

규칙:
- 초록 점선: 배치 가능
- 빨간 영역: 충돌 (배치 불가)
- 드롭 시 자동 스냅 (U 단위)
```

### 5.5 사진 뷰어
```
┌─────────────────────────────────────────────────────────────┐
│ 📷 RACK-A01 정면 사진                                  [X]  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                    ┌───────────────────┐                    │
│                    │                   │                    │
│                    │                   │                    │
│                    │    (실제 사진)    │                    │
│                    │                   │                    │
│                    │                   │                    │
│                    │                   │                    │
│                    └───────────────────┘                    │
│                                                             │
│              [이전]  정면 / 후면  [다음]                     │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                    [다운로드]  [닫기]                        │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. 설비 타입 및 표시

### 6.1 설비 카테고리
| 카테고리 | 설명 | 색상 |
|----------|------|------|
| SERVER | 서버 | #4A90D9 (파랑) |
| NETWORK | 네트워크 장비 (스위치, 라우터) | #50C878 (초록) |
| STORAGE | 스토리지 (NAS, SAN) | #9B59B6 (보라) |
| POWER | 전원 장비 (PDU, UPS) | #E67E22 (주황) |
| SECURITY | 보안 장비 (방화벽, IDS) | #E74C3C (빨강) |
| OTHER | 기타 | #95A5A6 (회색) |

### 6.2 설비 블록 표시 정보
```
┌─────────────────────────────────────┐
│  설비명                             │  ← 상단: 설비 이름
│  모델명                             │  ← 중단: 모델명 (있는 경우)
│  ○○○○ ○○                          │  ← 하단: 포트 아이콘 (연결 상태)
└─────────────────────────────────────┘

포트 아이콘:
● 연결됨 (채워진 원)
○ 미연결 (빈 원)
색상: 포트 타입별 (AC: 빨강, DC: 주황, LAN: 파랑, 광: 초록)
```

---

## 7. 비즈니스 규칙

### BR-01: U 슬롯 중복 방지
- 동일 랙 내에서 설비 U 범위가 겹칠 수 없음
- 배치/이동 시 충돌 검사 필수
- 충돌 시 에러 메시지와 함께 충돌 설비 정보 제공

### BR-02: U 범위 유효성
- start_u: 1 이상
- start_u + height_u - 1 <= total_u (랙 총 U 수 초과 불가)

### BR-03: 설비 삭제 제약
- 연결된 케이블이 있는 경우 삭제 전 확인
- 삭제 시 관련 포트, 케이블 연결 정보도 삭제

### BR-04: 이미지 제약
- 허용 형식: JPG, PNG
- 최대 크기: 5MB
- 서버에서 리사이징: 최대 1920px

---

## 8. 에러 코드

| 코드 | 설명 |
|------|------|
| RACK_NOT_FOUND | 랙을 찾을 수 없음 |
| EQUIPMENT_NOT_FOUND | 설비를 찾을 수 없음 |
| U_SLOT_CONFLICT | U 슬롯 충돌 |
| U_POSITION_INVALID | 유효하지 않은 U 위치 |
| U_EXCEEDS_RACK | 랙 총 U 수 초과 |
| HAS_CONNECTIONS | 연결된 케이블 존재 |
| IMAGE_TOO_LARGE | 이미지 크기 초과 |
| INVALID_IMAGE_FORMAT | 지원하지 않는 이미지 형식 |

---

## 9. 테스트 케이스

### TC-01: 설비 배치
1. 랙 에디터 열기
2. 빈 U 슬롯에 설비 드래그
3. **Expected**: 설비 배치됨

### TC-02: U 슬롯 충돌
1. 이미 설비가 있는 U 슬롯에 배치 시도
2. **Expected**: 빨간색 표시, 배치 불가

### TC-03: 설비 이동
1. 설비 선택
2. 다른 빈 슬롯으로 드래그
3. **Expected**: 설비 이동됨

### TC-04: 설비 정보 수정
1. 설비 더블클릭
2. 정보 수정 후 저장
3. **Expected**: 정보 업데이트됨

### TC-05: 사진 업로드
1. 랙 정보 편집
2. 정면 사진 업로드
3. **Expected**: 사진 저장, 미리보기 표시

### TC-06: 연결된 설비 삭제
1. 케이블 연결이 있는 설비 삭제 시도
2. **Expected**: 확인 대화상자 표시

### TC-07: 범위 초과 배치
1. 40U 위치에 4U 설비 배치 시도 (42U 랙)
2. **Expected**: 에러 - 범위 초과
