# F06: 배선 관리 - 상세 PRD

## 1. 개요

### 1.1 기능 ID
**F06-CABLE-MANAGEMENT**

### 1.2 기능 설명
설비 간 물리적 케이블 연결을 정의하고, 평면도에서 케이블 경로를 시각화하는 기능. 케이블 종류별 필터링과 연결 장비 하이라이트를 지원한다.

### 1.3 우선순위
**P0** (필수)

---

## 2. 요구사항

### 2.1 기능 요구사항

#### FR-01: 케이블 연결 정의
| 항목 | 내용 |
|------|------|
| 연결 | 소스 포트 ↔ 타겟 포트 연결 |
| 케이블 타입 | AC, DC, LAN, FIBER |
| 속성 | 라벨, 길이, 색상 등 |

#### FR-02: 케이블 경로 표시
| 항목 | 내용 |
|------|------|
| 경로 | 평면도에서 랙 간 케이블 경로 선으로 표시 |
| 중간점 | 경로 중간점 편집 가능 |
| 색상 | 케이블 타입별 색상 구분 |

#### FR-03: 필터링
| 항목 | 내용 |
|------|------|
| 타입 필터 | AC/DC/LAN/FIBER 체크박스 필터 |
| 복합 필터 | 다중 타입 동시 선택 가능 |
| 전체 선택/해제 | 빠른 토글 |

#### FR-04: 연결 하이라이트
| 항목 | 내용 |
|------|------|
| 설비 클릭 | 해당 설비와 연결된 모든 케이블/장비 하이라이트 |
| 연결 추적 | 클릭한 설비 기준 연결 체인 표시 |
| 필터 적용 | 하이라이트에도 필터 적용 |

#### FR-05: 케이블 CRUD
| 항목 | 내용 |
|------|------|
| 생성 | 포트 간 연결 생성 |
| 수정 | 케이블 속성 수정 |
| 삭제 | 연결 삭제 |
| 경로 편집 | 평면도 경로점 편집 |

### 2.2 비기능 요구사항

| 항목 | 요구사항 |
|------|----------|
| 케이블 수 | 평면도당 최대 500개 |
| 경로점 수 | 케이블당 최대 20개 |
| 렌더링 | 필터 적용 시 < 100ms |

---

## 3. 데이터 모델

### 3.1 Cable 테이블
```sql
CREATE TABLE cables (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- 연결 정보
    source_port_id  UUID NOT NULL REFERENCES ports(id) ON DELETE CASCADE,
    target_port_id  UUID NOT NULL REFERENCES ports(id) ON DELETE CASCADE,

    -- 케이블 정보
    cable_type      VARCHAR(20) NOT NULL,   -- 'AC', 'DC', 'LAN', 'FIBER'
    label           VARCHAR(100),           -- 케이블 라벨
    length          FLOAT,                  -- 길이 (미터)
    color           VARCHAR(50),            -- 케이블 색상

    -- 평면도 경로 (JSON 배열)
    path_points     JSONB,                  -- [[x1,y1], [x2,y2], ...]

    -- 메타
    description     TEXT,
    created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by      UUID REFERENCES users(id),
    updated_by      UUID REFERENCES users(id),

    -- 제약 조건
    CONSTRAINT different_ports CHECK (source_port_id != target_port_id),
    CONSTRAINT unique_connection UNIQUE (source_port_id, target_port_id)
);

-- 인덱스
CREATE INDEX idx_cables_source ON cables(source_port_id);
CREATE INDEX idx_cables_target ON cables(target_port_id);
CREATE INDEX idx_cables_type ON cables(cable_type);

-- path_points 예시:
-- 소스 랙 중심점 → 중간점들 → 타겟 랙 중심점
-- [[100, 150], [200, 150], [200, 300], [350, 300]]
```

### 3.2 케이블 타입
```sql
-- cable_type 값 및 표시 색상
'AC'    -- AC 전원: #FF0000 (빨강)
'DC'    -- DC 전원: #FF8C00 (주황)
'LAN'   -- 이더넷: #0066CC (파랑)
'FIBER' -- 광케이블: #00AA00 (초록)
```

---

## 4. API 명세

### 4.1 케이블 목록 조회 (평면도 기준)
```
GET /api/floor-plans/:floorPlanId/cables

Query Parameters:
- cableType: string (optional, comma-separated: "AC,LAN")

Response (200):
{
    "cables": [
        {
            "id": "uuid",
            "cableType": "LAN",
            "label": "Server1-Switch1",
            "length": 3.5,
            "color": "blue",
            "pathPoints": [[100, 150], [200, 150], [200, 300], [350, 300]],
            "sourcePort": {
                "id": "uuid",
                "name": "eth0",
                "equipment": {
                    "id": "uuid",
                    "name": "서버 #1"
                },
                "rack": {
                    "id": "uuid",
                    "name": "RACK-A01",
                    "positionX": 100,
                    "positionY": 100
                }
            },
            "targetPort": {
                "id": "uuid",
                "name": "port24",
                "equipment": {
                    "id": "uuid",
                    "name": "Core Switch"
                },
                "rack": {
                    "id": "uuid",
                    "name": "RACK-B01",
                    "positionX": 350,
                    "positionY": 250
                }
            }
        }
    ],
    "summary": {
        "total": 45,
        "byType": {
            "AC": 20,
            "DC": 5,
            "LAN": 15,
            "FIBER": 5
        }
    }
}
```

### 4.2 설비 연결 조회
```
GET /api/equipment/:equipmentId/connections

Response (200):
{
    "equipment": {
        "id": "uuid",
        "name": "서버 #1",
        "rack": "RACK-A01"
    },
    "connections": [
        {
            "cableId": "uuid",
            "cableType": "LAN",
            "direction": "outgoing",  // 또는 "incoming"
            "localPort": {
                "id": "uuid",
                "name": "eth0"
            },
            "remotePort": {
                "id": "uuid",
                "name": "port24"
            },
            "remoteEquipment": {
                "id": "uuid",
                "name": "Core Switch",
                "rack": "RACK-B01"
            }
        },
        {
            "cableId": "uuid",
            "cableType": "AC",
            "direction": "outgoing",
            "localPort": {
                "id": "uuid",
                "name": "pwr1"
            },
            "remotePort": {
                "id": "uuid",
                "name": "outlet1"
            },
            "remoteEquipment": {
                "id": "uuid",
                "name": "PDU-A",
                "rack": "RACK-A01"
            }
        }
    ],
    "summary": {
        "totalConnections": 5,
        "byType": {
            "AC": 2,
            "LAN": 3
        }
    }
}
```

### 4.3 케이블 생성
```
POST /api/cables
Authorization: Bearer {accessToken}
Role: admin

Request:
{
    "sourcePortId": "uuid",
    "targetPortId": "uuid",
    "cableType": "LAN",
    "label": "Server1-Switch1",
    "length": 3.5,
    "color": "blue",
    "pathPoints": [[100, 150], [200, 150], [200, 300], [350, 300]],
    "description": "메인 서버 네트워크 연결"
}

Response (201):
{
    "id": "uuid",
    "cableType": "LAN",
    ...
}

Error (409):
{
    "error": "PORT_ALREADY_CONNECTED",
    "message": "해당 포트는 이미 연결되어 있습니다.",
    "existingConnection": {
        "cableId": "uuid",
        "connectedTo": "다른 설비명"
    }
}

Error (400):
{
    "error": "PORT_TYPE_MISMATCH",
    "message": "케이블 타입과 포트 타입이 일치하지 않습니다."
}
```

### 4.4 케이블 수정
```
PUT /api/cables/:id
Authorization: Bearer {accessToken}
Role: admin

Request:
{
    "label": "Updated Label",
    "length": 4.0,
    "color": "gray",
    "pathPoints": [[100, 150], [250, 150], [250, 300], [350, 300]],
    "description": "업데이트된 설명"
}

Response (200):
{
    "id": "uuid",
    ...
}
```

### 4.5 케이블 경로 업데이트 (에디터용)
```
PATCH /api/cables/:id/path
Authorization: Bearer {accessToken}
Role: admin

Request:
{
    "pathPoints": [[100, 150], [180, 150], [180, 320], [350, 320]]
}

Response (200):
{
    "id": "uuid",
    "pathPoints": [...]
}
```

### 4.6 케이블 삭제
```
DELETE /api/cables/:id
Authorization: Bearer {accessToken}
Role: admin

Response (200):
{
    "message": "케이블이 삭제되었습니다."
}
```

### 4.7 연결 가능한 포트 조회
```
GET /api/ports/:portId/available-targets

Query Parameters:
- cableType: string (required)

Response (200):
{
    "availablePorts": [
        {
            "id": "uuid",
            "name": "port24",
            "portType": "LAN",
            "equipment": {
                "id": "uuid",
                "name": "Core Switch"
            },
            "rack": {
                "id": "uuid",
                "name": "RACK-B01"
            }
        }
    ]
}
```

---

## 5. 화면 설계

### 5.1 평면도에서 케이블 표시
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 📐 B1층 ICT실 평면도                                    [필터] [편집] [뷰어]    │
├─────────┬───────────────────────────────────────────────────────────────────────┤
│         │                                                                       │
│ 필터    │     ┌─────────────────────────────────────────────────────┐           │
│         │     │                                                     │           │
│ 케이블  │     │   ┌──────┐══════════════════════┌──────┐           │           │
│ ☑ AC    │     │   │RACK  │                      │RACK  │           │           │
│ ☑ DC    │     │   │ A01  │──────────────────────│ B01  │           │           │
│ ☑ LAN   │     │   └──────┘══════════════════════└──────┘           │           │
│ ☑ 광    │     │       │                             │               │           │
│         │     │       │    ┌──────┐                 │               │           │
│ ─────── │     │       └════│ PDU  │═════════════════┘               │           │
│         │     │            └──────┘                                 │           │
│ [전체]  │     │                                                     │           │
│ [해제]  │     └─────────────────────────────────────────────────────┘           │
│         │                                                                       │
│         │     범례: ══ AC(빨강)  ── LAN(파랑)  ┄┄ 광(초록)                       │
└─────────┴───────────────────────────────────────────────────────────────────────┘

케이블 스타일:
════ AC 전원 (빨강, 두꺼운 실선)
──── DC 전원 (주황, 실선)
──── LAN (파랑, 실선)
┄┄┄┄ 광케이블 (초록, 파선)
```

### 5.2 설비 클릭 시 연결 하이라이트
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                                                                 │
│     ┌─────────────────────────────────────────────────────┐                     │
│     │                                                     │                     │
│     │   ┌──────┐                      ┌──────┐           │                     │
│     │   │▓▓▓▓▓▓│══════════════════════│░░░░░░│           │                     │
│     │   │RACK  │──────────────────────│RACK  │           │  ▓ 선택된 랙        │
│     │   │ A01  │══════════════════════│ B01  │           │  ░ 연결된 랙        │
│     │   │▓▓▓▓▓▓│                      │░░░░░░│           │  ═ 연결 케이블      │
│     │   └──────┘                      └──────┘           │                     │
│     │       ║                             │               │                     │
│     │       ║    ┌──────┐                 │               │                     │
│     │       ╚════│░░░░░░│═════════════════╝               │                     │
│     │            │ PDU  │                                 │                     │
│     │            └──────┘                                 │                     │
│     │                                                     │                     │
│     └─────────────────────────────────────────────────────┘                     │
│                                                                                 │
│  선택: RACK-A01 | 연결된 장비: 2개 (RACK-B01, PDU)                               │
│  케이블: AC 2개, LAN 3개                                                        │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 케이블 연결 에디터
```
┌─────────────────────────────────────────────────────────────┐
│ 케이블 연결                                            [X]  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 소스                                                        │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 랙: RACK-A01                                     ▼      │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 설비: 서버 #1                                    ▼      │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 포트: eth0 (LAN, 미연결)                         ▼      │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│                          ↕                                  │
│                                                             │
│ 타겟                                                        │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 랙: RACK-B01                                     ▼      │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 설비: Core Switch                                ▼      │ │
│ └─────────────────────────────────────────────────────────┘ │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 포트: port24 (LAN, 미연결)                       ▼      │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ─────────────────────────────────────────────────────────── │
│                                                             │
│ 케이블 정보                                                 │
│ 타입: ● LAN  ○ AC  ○ DC  ○ 광                              │
│                                                             │
│ 라벨           ┌──────────────────────────────────┐         │
│                │ Server1-Switch1                  │         │
│                └──────────────────────────────────┘         │
│                                                             │
│ 길이 (m)       ┌──────────────────────────────────┐         │
│                │ 3.5                              │         │
│                └──────────────────────────────────┘         │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│                         [취소]  [연결]                       │
└─────────────────────────────────────────────────────────────┘
```

### 5.4 케이블 경로 편집 (평면도 에디터)
```
케이블 경로 편집 모드:

┌─────────────────────────────────────────────────────────────┐
│                                                             │
│     ┌──────┐                              ┌──────┐         │
│     │RACK  │                              │RACK  │         │
│     │ A01  ●────────●                     │ B01  │         │
│     └──────┘        │                     └──────┘         │
│                     │                         ●            │
│                     │                         │            │
│                     ●─────────────────────────●            │
│                                                             │
│     ● 경로점 (드래그 가능)                                  │
│     + 더블클릭: 경로점 추가                                  │
│     - 경로점 우클릭: 삭제                                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5.5 케이블 목록 (관리 화면)
```
┌─────────────────────────────────────────────────────────────────────────┐
│ 케이블 관리 - B1층 ICT실                                                │
├─────────────────────────────────────────────────────────────────────────┤
│ 필터: [AC ▼] [DC ▼] [LAN ▼] [광 ▼]                    [+ 케이블 추가]  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ ┌─────────────────────────────────────────────────────────────────────┐ │
│ │ 타입 │ 라벨              │ 소스                │ 타겟              │ │
│ ├──────┼───────────────────┼────────────────────┼───────────────────┤ │
│ │ LAN  │ Server1-Switch1   │ 서버#1/eth0        │ Switch/port24    │ │
│ │ LAN  │ Server1-Switch2   │ 서버#1/eth1        │ Switch/port25    │ │
│ │ AC   │ Server1-Power1    │ 서버#1/pwr1        │ PDU-A/outlet1    │ │
│ │ AC   │ Server1-Power2    │ 서버#1/pwr2        │ PDU-B/outlet1    │ │
│ │ 광   │ Switch-Core       │ Switch/sfp1        │ CoreSW/sfp1      │ │
│ └─────────────────────────────────────────────────────────────────────┘ │
│                                                                         │
│ 전체: 45개 | AC: 20 | DC: 5 | LAN: 15 | 광: 5                           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 케이블 타입 및 스타일

### 6.1 타입별 색상 및 스타일
| 타입 | 색상 코드 | 선 스타일 | 두께 |
|------|----------|----------|------|
| AC | #FF0000 | solid | 3px |
| DC | #FF8C00 | solid | 3px |
| LAN | #0066CC | solid | 2px |
| FIBER | #00AA00 | dashed | 2px |

### 6.2 상태별 스타일
| 상태 | 스타일 |
|------|--------|
| 기본 | 타입별 색상 |
| 호버 | 밝게 + 두껍게 |
| 선택됨 | 강조 색상 + 그림자 |
| 하이라이트 | 애니메이션 (점선 이동) |
| 흐림 (필터 제외) | 50% 투명도 |

---

## 7. 비즈니스 규칙

### BR-01: 포트 1:1 연결
- 하나의 포트는 하나의 케이블만 연결 가능
- 이미 연결된 포트에 연결 시도 시 에러

### BR-02: 포트-케이블 타입 일치
- LAN 포트 ↔ LAN 케이블
- FIBER 포트 ↔ FIBER 케이블
- AC 포트 ↔ AC 케이블
- DC 포트 ↔ DC 케이블
- 불일치 시 경고 (강제 연결 가능)

### BR-03: 자기 연결 방지
- 동일 포트 간 연결 불가
- 동일 설비 내 포트 간 연결은 허용 (루프백)

### BR-04: 경로 자동 생성
- 연결 생성 시 기본 경로 자동 생성 (직선)
- 사용자가 경로점 편집 가능

---

## 8. 에러 코드

| 코드 | 설명 |
|------|------|
| CABLE_NOT_FOUND | 케이블을 찾을 수 없음 |
| PORT_ALREADY_CONNECTED | 포트에 이미 연결된 케이블 존재 |
| PORT_TYPE_MISMATCH | 케이블 타입과 포트 타입 불일치 |
| SELF_CONNECTION | 동일 포트 간 연결 시도 |
| INVALID_PATH_POINTS | 유효하지 않은 경로점 |

---

## 9. 테스트 케이스

### TC-01: 케이블 연결 생성
1. 케이블 연결 모달 열기
2. 소스/타겟 포트 선택
3. 케이블 정보 입력 후 연결
4. **Expected**: 케이블 생성, 평면도에 경로 표시

### TC-02: 이미 연결된 포트
1. 연결된 포트에 다시 연결 시도
2. **Expected**: 에러 메시지 표시

### TC-03: 케이블 필터링
1. AC 체크 해제
2. **Expected**: AC 케이블만 숨김

### TC-04: 설비 클릭 하이라이트
1. 랙 또는 설비 클릭
2. **Expected**: 연결된 케이블과 장비 하이라이트

### TC-05: 경로 편집
1. 케이블 선택
2. 경로점 드래그
3. **Expected**: 경로 변경됨

### TC-06: 필터 + 하이라이트 조합
1. LAN만 필터 선택
2. 설비 클릭
3. **Expected**: 해당 설비의 LAN 연결만 하이라이트
